<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 2400" font-family="Arial, sans-serif">
  <defs>
    <style>
      .box { fill: #e3f2fd; stroke: #1976d2; stroke-width: 2; }
      .box-start { fill: #c8e6c9; stroke: #388e3c; stroke-width: 2; }
      .box-end { fill: #fff9c4; stroke: #f57c00; stroke-width: 2; }
      .box-query { fill: #f3e5f5; stroke: #7b1fa2; stroke-width: 2; }
      .box-transform { fill: #ffe0b2; stroke: #e64a19; stroke-width: 2; }
      .box-consolidate { fill: #b2dfdb; stroke: #00796b; stroke-width: 2; }
      .text { font-size: 14px; fill: #000; }
      .text-small { font-size: 12px; fill: #555; }
      .text-code { font-size: 11px; fill: #666; font-family: monospace; }
      .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-data { stroke: #d32f2f; stroke-width: 2; fill: none; marker-end: url(#arrowhead-red); }
      .title { font-size: 20px; font-weight: bold; fill: #1976d2; }
      .section-title { font-size: 16px; font-weight: bold; fill: #f57c00; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
    <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#d32f2f" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="700" y="30" text-anchor="middle" class="title">EdgeLake Query Node Flow: SQL Query Execution</text>
  <text x="700" y="55" text-anchor="middle" class="text-small">From run_client() to unified results</text>

  <!-- START -->
  <rect x="550" y="80" width="300" height="60" rx="5" class="box-start"/>
  <text x="700" y="105" text-anchor="middle" class="text" font-weight="bold">run_client()</text>
  <text x="700" y="125" text-anchor="middle" class="text-small">member_cmd.py:3133</text>

  <!-- Arrow -->
  <path d="M 700 140 L 700 180" class="arrow"/>

  <!-- Preprocess Command -->
  <rect x="550" y="180" width="300" height="80" rx="5" class="box"/>
  <text x="700" y="205" text-anchor="middle" class="text">preprocess_command()</text>
  <text x="700" y="225" text-anchor="middle" class="text-small">Parse destinations (IPs/Ports)</text>
  <text x="700" y="245" text-anchor="middle" class="text-small">Extract SQL statement</text>

  <!-- Arrow -->
  <path d="M 700 260 L 700 300" class="arrow"/>

  <!-- Get SQL Processing Info -->
  <rect x="550" y="300" width="300" height="80" rx="5" class="box"/>
  <text x="700" y="325" text-anchor="middle" class="text">get_sql_processing_info()</text>
  <text x="700" y="345" text-anchor="middle" class="text-small">Extract DBMS name</text>
  <text x="700" y="365" text-anchor="middle" class="text-small">Parse conditions (format, dest, etc.)</text>

  <!-- Arrow -->
  <path d="M 700 380 L 700 420" class="arrow"/>

  <!-- Send Command Message -->
  <rect x="550" y="420" width="300" height="100" rx="5" class="box-query"/>
  <text x="700" y="445" text-anchor="middle" class="text" font-weight="bold">send_command_message()</text>
  <text x="700" y="465" text-anchor="middle" class="text-small">member_cmd.py:3181</text>
  <text x="700" y="485" text-anchor="middle" class="text-small">Create job instance</text>
  <text x="700" y="505" text-anchor="middle" class="text-small">Initialize select_parsed</text>

  <!-- Arrow -->
  <path d="M 700 520 L 700 560" class="arrow"/>

  <!-- SECTION: QUERY TRANSFORMATION -->
  <rect x="50" y="550" width="1300" height="550" fill="#fff3e0" stroke="#ff6f00" stroke-width="2" rx="10"/>
  <text x="700" y="580" text-anchor="middle" class="section-title">QUERY TRANSFORMATION (Query Node Only)</text>

  <!-- Select Parser -->
  <rect x="150" y="600" width="300" height="100" rx="5" class="box-transform"/>
  <text x="300" y="625" text-anchor="middle" class="text">select_parser()</text>
  <text x="300" y="645" text-anchor="middle" class="text-small">db_info.py</text>
  <text x="300" y="665" text-anchor="middle" class="text-small">Parse SELECT statement</text>
  <text x="300" y="685" text-anchor="middle" class="text-small">Extract table, columns, functions</text>

  <!-- Arrow right -->
  <path d="M 450 650 L 550 650" class="arrow"/>

  <!-- Make SQL Statement -->
  <rect x="550" y="600" width="300" height="100" rx="5" class="box-transform"/>
  <text x="700" y="625" text-anchor="middle" class="text" font-weight="bold">unify_results.make_sql_stmt()</text>
  <text x="700" y="645" text-anchor="middle" class="text-small">member_cmd.py:3284</text>
  <text x="700" y="665" text-anchor="middle" class="text-small">Determines if query needs</text>
  <text x="700" y="685" text-anchor="middle" class="text-small">transformation</text>

  <!-- Arrow right -->
  <path d="M 850 650 L 950 650" class="arrow"/>

  <!-- Query Prep -->
  <rect x="950" y="600" width="300" height="100" rx="5" class="box-transform"/>
  <text x="1100" y="625" text-anchor="middle" class="text" font-weight="bold">query_prep()</text>
  <text x="1100" y="645" text-anchor="middle" class="text-small">unify_results.py:48-176</text>
  <text x="1100" y="665" text-anchor="middle" class="text-small">Generate 3 SQL statements:</text>
  <text x="1100" y="685" text-anchor="middle" class="text-code">remote_query, local_create, local_query</text>

  <!-- Arrow down from query_prep -->
  <path d="M 1100 700 L 1100 760" class="arrow"/>

  <!-- Function-Specific Transformations (3 boxes side by side) -->
  <rect x="150" y="760" width="300" height="100" rx="5" class="box-transform"/>
  <text x="300" y="785" text-anchor="middle" class="text-small" font-weight="bold">AVG Transformation</text>
  <text x="300" y="805" text-anchor="middle" class="text-code">Remote: SUM(x), COUNT(x)</text>
  <text x="300" y="825" text-anchor="middle" class="text-code">Local: SUM(sum_x) /</text>
  <text x="300" y="845" text-anchor="middle" class="text-code">  SUM(count_x)</text>

  <rect x="550" y="760" width="300" height="100" rx="5" class="box-transform"/>
  <text x="700" y="785" text-anchor="middle" class="text-small" font-weight="bold">COUNT Transformation</text>
  <text x="700" y="805" text-anchor="middle" class="text-code">Remote: COUNT(x)</text>
  <text x="700" y="825" text-anchor="middle" class="text-code">Local: SUM(count_x)</text>

  <rect x="950" y="760" width="300" height="100" rx="5" class="box-transform"/>
  <text x="1100" y="785" text-anchor="middle" class="text-small" font-weight="bold">MIN/MAX Transformation</text>
  <text x="1100" y="805" text-anchor="middle" class="text-code">Remote: MIN(x) / MAX(x)</text>
  <text x="1100" y="825" text-anchor="middle" class="text-code">Local: MIN(min_x) /</text>
  <text x="1100" y="845" text-anchor="middle" class="text-code">  MAX(max_x)</text>

  <!-- Arrow down from transformations -->
  <path d="M 700 860 L 700 920" class="arrow"/>

  <!-- Store Queries in Job Instance -->
  <rect x="550" y="920" width="300" height="100" rx="5" class="box-transform"/>
  <text x="700" y="945" text-anchor="middle" class="text">Store in job_instance</text>
  <text x="700" y="965" text-anchor="middle" class="text-code">set_generic_query(remote_query)</text>
  <text x="700" y="985" text-anchor="middle" class="text-code">set_local_table(query_N)</text>
  <text x="700" y="1005" text-anchor="middle" class="text-code">set_local_query(local_query)</text>

  <!-- Arrow -->
  <path d="M 700 1020 L 700 1120" class="arrow"/>

  <!-- END OF TRANSFORMATION SECTION -->

  <!-- SECTION: DISTRIBUTED EXECUTION -->
  <rect x="50" y="1110" width="1300" height="400" fill="#e8f5e9" stroke="#388e3c" stroke-width="2" rx="10"/>
  <text x="700" y="1140" text-anchor="middle" class="section-title">DISTRIBUTED EXECUTION (MapReduce)</text>

  <!-- Get Generic Query -->
  <rect x="550" y="1160" width="300" height="80" rx="5" class="box-query"/>
  <text x="700" y="1185" text-anchor="middle" class="text">get_generic_query()</text>
  <text x="700" y="1205" text-anchor="middle" class="text-small">member_cmd.py:3435</text>
  <text x="700" y="1225" text-anchor="middle" class="text-small">Format: sql dbms [conditions] remote_query</text>

  <!-- Arrow -->
  <path d="M 700 1240 L 700 1280" class="arrow"/>

  <!-- Send to Operators -->
  <rect x="550" y="1280" width="300" height="80" rx="5" class="box-query"/>
  <text x="700" y="1305" text-anchor="middle" class="text" font-weight="bold">Send to Operator Nodes</text>
  <text x="700" y="1325" text-anchor="middle" class="text-small">TCP message with remote_query</text>
  <text x="700" y="1345" text-anchor="middle" class="text-small">Parallel execution on all nodes</text>

  <!-- Operator boxes (side by side) -->
  <rect x="150" y="1400" width="200" height="80" rx="5" class="box" opacity="0.6"/>
  <text x="250" y="1430" text-anchor="middle" class="text-small">Operator 1</text>
  <text x="250" y="1450" text-anchor="middle" class="text-small">Execute remote_query</text>
  <text x="250" y="1470" text-anchor="middle" class="text-small">Return partial results</text>

  <rect x="450" y="1400" width="200" height="80" rx="5" class="box" opacity="0.6"/>
  <text x="550" y="1430" text-anchor="middle" class="text-small">Operator 2</text>
  <text x="550" y="1450" text-anchor="middle" class="text-small">Execute remote_query</text>
  <text x="550" y="1470" text-anchor="middle" class="text-small">Return partial results</text>

  <rect x="750" y="1400" width="200" height="80" rx="5" class="box" opacity="0.6"/>
  <text x="850" y="1430" text-anchor="middle" class="text-small">Operator 3</text>
  <text x="850" y="1450" text-anchor="middle" class="text-small">Execute remote_query</text>
  <text x="850" y="1470" text-anchor="middle" class="text-small">Return partial results</text>

  <rect x="1050" y="1400" width="200" height="80" rx="5" class="box" opacity="0.6"/>
  <text x="1150" y="1430" text-anchor="middle" class="text-small">Operator N</text>
  <text x="1150" y="1450" text-anchor="middle" class="text-small">Execute remote_query</text>
  <text x="1150" y="1470" text-anchor="middle" class="text-small">Return partial results</text>

  <!-- Arrows back to Query Node -->
  <path d="M 250 1480 L 700 1530" class="arrow-data"/>
  <path d="M 550 1480 L 700 1530" class="arrow-data"/>
  <path d="M 850 1480 L 700 1530" class="arrow-data"/>
  <path d="M 1150 1480 L 700 1530" class="arrow-data"/>

  <!-- Arrow -->
  <path d="M 700 1530 L 700 1580" class="arrow"/>

  <!-- SECTION: CONSOLIDATION -->
  <rect x="50" y="1570" width="1300" height="520" fill="#e1f5fe" stroke="#0277bd" stroke-width="2" rx="10"/>
  <text x="700" y="1600" text-anchor="middle" class="section-title">CONSOLIDATION (Reduce Phase)</text>

  <!-- Insert Query Rows -->
  <rect x="550" y="1620" width="300" height="80" rx="5" class="box-consolidate"/>
  <text x="700" y="1645" text-anchor="middle" class="text">insert_query_rows()</text>
  <text x="700" y="1665" text-anchor="middle" class="text-small">member_cmd.py:12867</text>
  <text x="700" y="1685" text-anchor="middle" class="text-small">Insert operator results into query_N table</text>

  <!-- Arrow -->
  <path d="M 700 1700 L 700 1740" class="arrow"/>

  <!-- Process All Nodes Replied -->
  <rect x="550" y="1740" width="300" height="80" rx="5" class="box-consolidate"/>
  <text x="700" y="1765" text-anchor="middle" class="text">process_all_nodes_replied()</text>
  <text x="700" y="1785" text-anchor="middle" class="text-small">member_cmd.py:12437</text>
  <text x="700" y="1805" text-anchor="middle" class="text-small">Wait for all operators to respond</text>

  <!-- Arrow -->
  <path d="M 700 1820 L 700 1860" class="arrow"/>

  <!-- Create Temp Table -->
  <rect x="150" y="1860" width="300" height="100" rx="5" class="box-consolidate"/>
  <text x="300" y="1885" text-anchor="middle" class="text">Create Temp Table</text>
  <text x="300" y="1905" text-anchor="middle" class="text-small">Table: query_N</text>
  <text x="300" y="1925" text-anchor="middle" class="text-small">DBMS: system_query</text>
  <text x="300" y="1945" text-anchor="middle" class="text-code">CREATE TABLE query_N (...)</text>

  <!-- Arrow right -->
  <path d="M 450 1910 L 550 1910" class="arrow"/>

  <!-- Query Local Table -->
  <rect x="550" y="1860" width="300" height="100" rx="5" class="box-consolidate"/>
  <text x="700" y="1885" text-anchor="middle" class="text" font-weight="bold">query_local_table()</text>
  <text x="700" y="1905" text-anchor="middle" class="text-small">member_cmd.py:12399</text>
  <text x="700" y="1925" text-anchor="middle" class="text-small">Execute local_query against</text>
  <text x="700" y="1945" text-anchor="middle" class="text-small">temp table query_N</text>

  <!-- Arrow right -->
  <path d="M 850 1910 L 950 1910" class="arrow"/>

  <!-- Process Query Sequence (Final) -->
  <rect x="950" y="1860" width="300" height="100" rx="5" class="box-consolidate"/>
  <text x="1100" y="1885" text-anchor="middle" class="text">process_query_sequence()</text>
  <text x="1100" y="1905" text-anchor="middle" class="text-small">Execute aggregation SQL</text>
  <text x="1100" y="1925" text-anchor="middle" class="text-code">SELECT SUM(sum_temp) /</text>
  <text x="1100" y="1945" text-anchor="middle" class="text-code">  SUM(count_temp) FROM query_N</text>

  <!-- Arrow down -->
  <path d="M 700 1960 L 700 2000" class="arrow"/>

  <!-- Query Row by Row -->
  <rect x="550" y="2000" width="300" height="80" rx="5" class="box-consolidate"/>
  <text x="700" y="2025" text-anchor="middle" class="text">query_row_by_row() or</text>
  <text x="700" y="2045" text-anchor="middle" class="text">process_fetch_rows()</text>
  <text x="700" y="2065" text-anchor="middle" class="text-small">Fetch final consolidated results</text>

  <!-- Arrow -->
  <path d="M 700 2080 L 700 2120" class="arrow"/>

  <!-- END -->
  <rect x="550" y="2120" width="300" height="100" rx="5" class="box-end"/>
  <text x="700" y="2145" text-anchor="middle" class="text" font-weight="bold">Return Unified Results</text>
  <text x="700" y="2165" text-anchor="middle" class="text-small">To application via:</text>
  <text x="700" y="2185" text-anchor="middle" class="text-small">REST API / TCP / stdout</text>
  <text x="700" y="2205" text-anchor="middle" class="text-small">Drop temp table query_N</text>

  <!-- Side annotations -->
  <text x="50" y="800" class="text-small" font-style="italic">Transform</text>
  <text x="50" y="820" class="text-small" font-style="italic">functions:</text>
  <text x="50" y="840" class="text-small" font-style="italic">avg_sql()</text>
  <text x="50" y="860" class="text-small" font-style="italic">count_sql()</text>
  <text x="50" y="880" class="text-small" font-style="italic">min_max_sql()</text>

  <text x="1320" y="1440" class="text-small" font-style="italic" text-anchor="end">Map Phase:</text>
  <text x="1320" y="1460" class="text-small" font-style="italic" text-anchor="end">Parallel</text>
  <text x="1320" y="1480" class="text-small" font-style="italic" text-anchor="end">execution</text>

  <text x="1320" y="1910" class="text-small" font-style="italic" text-anchor="end">Reduce Phase:</text>
  <text x="1320" y="1930" class="text-small" font-style="italic" text-anchor="end">SQL-based</text>
  <text x="1320" y="1950" class="text-small" font-style="italic" text-anchor="end">aggregation</text>

  <!-- Legend -->
  <text x="50" y="2350" class="text-small" font-weight="bold">Key Components:</text>
  <rect x="50" y="2360" width="20" height="20" class="box-transform"/>
  <text x="75" y="2375" class="text-small">Query Transformation (unify_results.py)</text>

  <rect x="320" y="2360" width="20" height="20" class="box-query"/>
  <text x="345" y="2375" class="text-small">Query Processing (member_cmd.py)</text>

  <rect x="590" y="2360" width="20" height="20" class="box-consolidate"/>
  <text x="615" y="2375" class="text-small">Result Consolidation</text>

</svg>
